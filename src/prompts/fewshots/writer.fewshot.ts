// src/prompts/fewshots/writer.fewshot.ts
// Runtime非依存の純関数モジュール
//
// 目的:
// - /app/api/writer/route.ts が利用する few-shot 例文を一元管理する
// - Precision Plan v3-compact (tests-augmented) の制約を守りつつ
//   H-7-⑥のブランドトーン（落ち着いた知性 / あたたかい安心 / 押しつけない提案）を導入ブロックに反映する
//
// 重要事項:
// - WRITER_FEWSHOT=1/true のときのみ few-shot を返す。それ以外は []。
// - カテゴリ判定は部分一致。家電 / コスメ / 食品 など。
// - 導入ブロックでは「こういう場面・こういう気持ちのときに役に立つ」という文脈を、恥や焦りではなく安心として提示する。
// - FAQ は2〜3問。返品・相性・使い方など読者が不安になりやすい点に落ち着いて答える。
// - CTA は「一次CTA：…」「代替CTA：…」の2行を必ず持ち、行動後の安心や見通しを短く添える。
// - 感嘆符（！）は使わないこと。誇大な断定をしないこと。医薬的効能を断定しないこと。
// - 数値・単位（時間、g、mAh、SPF/PA、mL、mmなど）を本文に2つ以上含める傾向を例として示す。
// - 見出しは最大H2（## まで）。
//
// export API:
//   buildFewShot(category: string): { role: "user" | "assistant"; content: string }[]
//
// 注意:
// - few-shotはモデルに「こういう感じで書いていいよ」という空気を教える。ここでの導入トーンが本番生成に大きく効く。
// - route.ts / postProcess.ts 側の最終整形（FAQ一元化・CTA挿入・footnote統合など）とは競合しないように設計してある。

export type FewShotMessage = {
  role: "user" | "assistant";
  content: string;
};

/**
 * WRITER_FEWSHOT=1/true のときだけカテゴリに応じたfew-shotを付与する。
 * - 家電
 * - コスメ
 * - 食品
 */
export function buildFewShot(category: string): FewShotMessage[] {
  if (!/^(1|true)$/i.test(String(process.env.WRITER_FEWSHOT ?? ""))) {
    return [];
  }

  const shots: FewShotMessage[] = [];

  // 家電系（イヤホン・ヘッドホン・ノイキャン・家電ジャンル全般）
  if (/(家電|electronic|電動|掃除機|冷蔵庫|イヤホン|ヘッドホン)/i.test(category ?? "")) {
    shots.push(
      {
        role: "user",
        content:
          // user側メタ要素：モデルに「こういうインプットが来るよ」と教える
          "【カテゴリ:家電】product_name: ノイズキャンセリング完全ワイヤレスイヤホン / goal: 購入誘導 / audience: 通勤・リモートワーク / keywords: 連続再生, 低遅延, 高音質",
      },
      {
        role: "assistant",
        content:
          // assistant側の回答スタイルのサンプル：H-7-⑥トーン反映版
          [
            "## 周りの音に振り回されたくない時間のために",
            "移動中でも、オンライン会議中でも、自分の声と相手の声だけに集中したい場面があります。周囲のざわつきや生活音をいったん落ち着かせたいとき、その助けになるのがノイズキャンセリング対応の完全ワイヤレスイヤホンです。",

            "- 最大10時間の連続再生（充電ケース併用で約30時間）なので、通勤とリモート会議をまたぐ日でも途中で慌てて充電しに行く必要がありません。",
            "- 低遅延モードはおよそ80〜120ms程度を想定しており、動画視聴や通話中の口元とのズレを減らします。",
            "- 生活防水はIPX4相当です。小雨やジム帰りの汗程度であれば日常使いしやすい設計です。",
            "- Bluetooth 5.3対応。スマホやPCとの切り替えもスムーズです。",

            "マイクは周囲の環境音を抑えつつ声を拾いやすいチューニングです。自宅からのオンライン会議でも、生活音をすべて消せるわけではありませんが、相手側に聞こえるノイズを一定程度やわらげる狙いがあります。",

            "## FAQ",
            "Q. iPhoneとAndroidの両方で使えますか？",
            "A. はい、Bluetooth接続に対応しています。マルチポイントの挙動など詳細な互換性は商品仕様をご確認ください。",

            "Q. 雨の日の屋外でも使えますか？",
            "A. IPX4相当の生活防水です。小雨や汗程度であれば想定されていますが、水に沈めるような使い方は避けてください。",

            "Q. バッテリーが劣化したら交換できますか？",
            "A. 内蔵バッテリーは消耗品です。初期不良は受領後7日以内に交換対応します。長期的な保証内容はメーカー保証（通常1年間）をご確認ください。",

            "一次CTA：今すぐ購入—まず試せます（30日以内は返品可）",
            "代替CTA：詳細を見る—実際の装着感や音質レビューを比較できます",
          ].join("\n")
      }
    );
  }

  // コスメ・スキンケア
  if (/(コスメ|化粧|美容|スキンケア|beauty|cosme)/i.test(category ?? "")) {
    shots.push(
      {
        role: "user",
        content:
          "【カテゴリ:コスメ】product_name: 低刺激UVミルク / goal: 購入誘導 / audience: 素肌思い / keywords: 日焼け止め, 乳液, トーンアップ",
      },
      {
        role: "assistant",
        content:
          [
            "## 肌の調子が安定しない日でも外に出たいときに",
            "「今日はちょっと敏感かも」という朝でも、外に出る以上はUVケアは避けられません。低刺激のUVミルクは、守りたいときに負担になりにくい使い方を目指しています。白浮きしにくい乳液テクスチャで、下地としても使いやすいタイプです。",

            "- SPF50+・PA++++で日中の紫外線から肌を守る設計です。",
            "- 使用量の目安はパール粒2個分（約0.8g）で、顔全体に薄くのばせます。",
            "- 紫外線吸収剤フリー、アルコールフリー、香料不使用の処方が多く、香りが強いアイテムが苦手な方でも取り入れやすいです。",

            "石けんオフに対応しているものが多く、単体使用時は洗顔料で落としやすいのも特徴です。ただし上に重ねるメイク製品によっては、通常のクレンジングが必要になる場合があります。",

            "## FAQ",
            "Q. 敏感肌でも使えますか？",
            "A. パッチテスト済ですが、すべての方に刺激がないとは限りません。心配な場合は、まず腕の内側など目立たない場所で少量を試してください。",

            "Q. 白浮きしませんか？",
            "A. トーンアップを狙った処方でも、厚く塗り過ぎると明るくなり過ぎる場合があります。パール粒2個分を目安に、少しずつ薄くのばす塗り方がおすすめです。",

            "Q. 石けんで落ちますか？",
            "A. 単体使用なら洗顔料で落とせる想定です。ただし重ね塗りや他のベースメイクとの組み合わせ次第では、クレンジングが必要になることがあります。",

            "一次CTA：今すぐ購入—まず試せます（香りや刺激が合わない場合は返品相談できます）",
            "代替CTA：成分を詳しく見る—自分の肌との相性を事前に確認できます",
          ].join("\n")
      }
    );
  }

  // 食品・飲料・コーヒーなど
  if (/(食品|フード|グルメ|スイーツ|food|gourmet|菓子|コーヒー|茶)/i.test(category ?? "")) {
    shots.push(
      {
        role: "user",
        content:
          "【カテゴリ:食品】product_name: プレミアムドリップコーヒー 10袋 / goal: 購入誘導 / audience: 在宅ワーク / keywords: 香り, 深煎り, 手軽",
      },
      {
        role: "assistant",
        content:
          [
            "## 作業の合間でも、ちゃんと淹れたての味を楽しみたいときに",
            "仕事の途中で一息入れたいけれど、豆を量って道具を並べるほどの余裕はない。そんなときのために、1杯ずつ個包装のドリップタイプがあります。香りのある深煎りを、お湯だけでさっと飲める形にしたものです。",

            "- 1袋あたり10〜12gの粉が入っていて、お湯150〜180mLが目安です。重めのコクが好きな人はお湯少なめで調整できます。",
            "- 焙煎後24時間以内に充填するなど、酸化しやすい香り成分を閉じ込める工夫がされています。",
            "- 深煎りなので、ミルクを加えてカフェオレ風にしても香りが埋もれにくいのが特徴です。",

            "パッケージは個包装なので持ち運びしやすく、デスクの引き出しやバッグにも入れやすい設計です。未開封なら常温保管で数か月〜12か月程度の賞味期限が目安とされることが多く、まとめ買いもしやすい部類です。",

            "## FAQ",
            "Q. 苦みは強いですか？",
            "A. 深煎りらしいコクがありますが、お湯をやや多め（170〜180mL）にすると角がやわらぎます。ミルクを足すとカフェオレ風にできます。",

            "Q. 賞味期限はどのくらいですか？",
            "A. 未開封なら製造からおおむね12か月を目安とすることが多いです。開封後は香りが抜けやすいので、早めのご利用をおすすめします。",

            "Q. 持ち歩きできますか？",
            "A. 個包装のままバッグに入れられます。オフィスや外出先のマグカップにも直接セットできる形状が多いです。",

            "一次CTA：今すぐ購入—まずは10袋から試せます（定期便はスキップ自由）",
            "代替CTA：詳細を見る—味のレビューや焙煎日の目安を確認できます",
          ].join("\n")
      }
    );
  }

  return shots;
}
