// app/api/writer/faq-lexicon.ts

import type { NormalizedInput } from "./pipeline";

/* =========================
   FAQ シード（全カテゴリ共通）
========================= */

export const faqSeeds = [
  {
    q: "配送までの目安は？",
    a: "通常はご注文から数日以内に出荷します（在庫状況などにより前後する場合があります）。",
  },
  {
    q: "返品・交換はできますか？",
    a: "未使用の状態で、商品到着後しばらくの期間は返品・交換を承ります。詳しくは返品ポリシーをご確認ください。",
  },
  {
    q: "支払い方法は？",
    a: "クレジットカード、コンビニ払い、銀行振込などに対応しています。",
  },
];

/* =========================
   EC Lexicon & Templates（カテゴリ別ヒント）
========================= */

export type ECLexicon = {
  cooccurrence: string[];
  numericTemplates: string[];
  safetyPhrases: string[];
};

export const EC_LEXICON: Record<string, ECLexicon> = {
  家電: {
    cooccurrence: [
      "連続再生",
      "低遅延",
      "ノイズキャンセリング",
      "バッテリー",
      "充電時間",
      "防水",
      "Bluetooth",
      "USB-C",
      "保証",
    ],
    numericTemplates: [
      "連続再生：長時間の利用に対応できる設計です。",
      "充電時間：比較的短時間で充電が完了しやすい設計です。",
      "重量：日常的に持ち運びしやすい軽さです。",
      "通信：Bluetooth 接続に対応しています（詳細は商品仕様をご確認ください）。",
    ],
    safetyPhrases: [
      "初期不良が疑われる場合は、商品到着後お早めにお問い合わせください。",
      "メーカー保証が付属しています（消耗品を除く場合があります）。",
      "お支払いは各種クレジットカードやコンビニ払いなどに対応しています。",
    ],
  },
  コスメ: {
    cooccurrence: [
      "SPF/PA",
      "トーンアップ",
      "白浮き",
      "石けんオフ",
      "敏感肌",
      "無香料",
      "紫外線吸収剤フリー",
      "アルコールフリー",
    ],
    numericTemplates: [
      "UVカット：日常使いに適した紫外線ケアが期待できます。",
      "使用量目安：適量を少しずつなじませてください。",
      "内容量：毎日のケアに使いやすい容量です。",
    ],
    safetyPhrases: [
      "パッチテスト済みですが、すべての方に刺激がないわけではありません。",
      "石けんで落とせます（単体使用時）。",
      "香料・着色料フリー（詳細は成分表をご確認ください）。",
    ],
  },
  食品: {
    cooccurrence: [
      "個包装",
      "鮮度",
      "焙煎",
      "抽出量",
      "保存方法",
      "賞味期限",
      "原材料",
    ],
    numericTemplates: [
      "抽出の目安：お好みに合わせて粉とお湯の量を調整してください。",
      "鮮度管理：焙煎や製造後のできるだけ早いタイミングで密封しています。",
      "賞味期限：未開封であれば、一定期間おいしくお召し上がりいただけます。",
    ],
    safetyPhrases: [
      "原材料にアレルギーがある方は成分表示をご確認ください。",
      "パッケージは予告なく変更される場合があります。",
      "定期便はいつでもスキップ可能です。",
    ],
  },
  アパレル: {
    cooccurrence: [
      "サイズ感",
      "生地厚",
      "伸縮性",
      "洗濯方法",
      "透け感",
      "シルエット",
      "着丈",
    ],
    numericTemplates: [
      "サイズ目安：一般的なサイズ感を基準にしたシルエットです。",
      "生地：綿素材を中心とした、日常使いしやすい厚みです。",
      "洗濯：ネット使用・中性洗剤・陰干し推奨です。",
    ],
    safetyPhrases: [
      "自宅での試着後でも、未使用でタグ付きの状態であれば返品を承ります。",
      "色味はモニター環境により実物と異なる場合があります。",
      "サイズ交換の送料はショップのルールに基づきご案内します。",
    ],
  },
  汎用: {
    cooccurrence: [
      "レビュー",
      "比較",
      "相性",
      "使い方",
      "保証",
      "サポート",
      "返品",
    ],
    numericTemplates: [
      "参考：返品保証や出荷タイミングについてはショップポリシーをご確認ください。",
      "目安：本体は日常的に扱いやすい重さとサイズ感です。",
    ],
    safetyPhrases: [
      "未使用品の返品を承っています。詳しい条件は返品ポリシーをご確認ください。",
      "土日祝の出荷についてはショップの営業日程により異なります。",
      "ご不明点はチャットサポートなどでお気軽にお問い合わせください。",
    ],
  },
};

/* =========================
   カテゴリ別 FAQ Seeds
========================= */

export type QA = { q: string; a: string; idx: number };

export function categoryFaqSeeds(cat: string): QA[] {
  const C = cat || "";
  const mk = (q: string, a: string): QA => ({
    q,
    a,
    idx: Number.MAX_SAFE_INTEGER,
  });

  if (/家電|electronic|電動|イヤホン|ヘッドホン|掃除機|冷蔵庫/i.test(C)) {
    return [
      mk(
        "保証期間はどのくらいですか？",
        "メーカー保証が付属しています（消耗品を除く場合があります）。詳細は商品ページの保証欄をご確認ください。",
      ),
      mk(
        "対応機種や互換性は？",
        "Bluetooth 接続に対応しています。対応するコーデックや機種の詳細は商品仕様をご確認ください。",
      ),
    ];
  }

  if (/コスメ|化粧|美容|スキンケア|cosme|beauty/i.test(C)) {
    return [
      mk(
        "敏感肌でも使えますか？",
        "パッチテスト済ですが、すべての方に刺激がないとは限りません。心配な場合は腕の内側でお試しください。",
      ),
      mk(
        "石けんで落ちますか？",
        "単体使用時は洗顔料で落とせます。重ね使い時はクレンジングをおすすめします。",
      ),
    ];
  }

  if (/食品|フード|グルメ|food|gourmet|菓子|コーヒー|茶/i.test(C)) {
    return [
      mk(
        "賞味期限はどのくらいですか？",
        "未開封であれば、一定期間おいしくお召し上がりいただけます。具体的な期限は商品パッケージや商品ページをご確認ください。",
      ),
      mk(
        "アレルギー表示は？",
        "アレルギーの原因となる原材料については、商品ページにわかりやすく表示しています。",
      ),
    ];
  }

  if (/アパレル|衣料|ファッション|服|ウェア/i.test(C)) {
    return [
      mk(
        "サイズ交換は可能ですか？",
        "未使用でタグ付きなどの条件を満たす場合は、商品到着後のサイズ交換を承ります。詳細は交換・返品ポリシーをご確認ください。",
      ),
      mk(
        "洗濯方法は？",
        "ネット使用・中性洗剤・陰干し推奨です。乾燥機は縮みの原因となるため避けてください。",
      ),
    ];
  }

  return faqSeeds.map((s) => ({
    q: s.q,
    a: s.a,
    idx: Number.MAX_SAFE_INTEGER,
  }));
}

/* =========================
   normalizeQ（FAQ 重複判定用）
========================= */

export function normalizeQ(s: string): string {
  let t = (s || "")
    .replace(/^[\s\d\.\):：）\-・\(\[]+/, "")
    .replace(/[？?\s\)\]]+$/g, "")
    .replace(/\s+/g, " ")
    .toLowerCase();

  const map: Array<[RegExp, string]> = [
    [/(返品|返金|交換)/g, "返品/交換"],
    [/(配送|到着|納期|発送|送料)/g, "配送/納期"],
    [/(支払い|支払|決済|支払方法)/g, "支払い方法"],
    [/(保証|修理|故障)/g, "保証"],
    [/(対応|互換|相性)/g, "対応/互換"],
    [/(アレルギー|含有|成分)/g, "アレルギー"],
    [/(サイズ|寸法|長さ)/g, "サイズ"],
  ];

  for (const [re, token] of map) {
    t = t.replace(re, token);
  }

  t = t.replace(/(は|って|とは|について|のこと|の)/g, "");
  t = t.replace(/\/{2,}/g, "/");

  return t.trim();
}
