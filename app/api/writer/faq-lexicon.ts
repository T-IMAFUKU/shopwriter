// app/api/writer/faq-lexicon.ts

import type { NormalizedInput } from "./pipeline";

/* =========================
   FAQ シード（全カテゴリ共通）
========================= */

export const faqSeeds = [
  {
    q: "配送までの目安は？",
    a: "通常はご注文から1〜3営業日で出荷します（在庫により前後）。",
  },
  {
    q: "返品・交換はできますか？",
    a: "未使用・到着後7日以内は承ります。詳細は返品ポリシーをご確認ください。",
  },
  {
    q: "支払い方法は？",
    a: "クレジットカード、コンビニ払い、銀行振込などに対応しています。",
  },
];

/* =========================
   EC Lexicon & Templates（カテゴリ別ヒント）
========================= */

export type ECLexicon = {
  cooccurrence: string[];
  numericTemplates: string[];
  safetyPhrases: string[];
};

export const EC_LEXICON: Record<string, ECLexicon> = {
  家電: {
    cooccurrence: [
      "連続再生",
      "低遅延",
      "ノイズキャンセリング",
      "バッテリー",
      "充電時間",
      "防水",
      "Bluetooth 5",
      "USB-C",
      "保証",
    ],
    numericTemplates: [
      "連続再生：最大10時間／ケース併用で約30時間",
      "充電時間：約90分（USB-C）",
      "重量：約120g／サイズ：約150mm",
      "通信：Bluetooth 5.3（対応コーデックは商品仕様をご確認ください）",
    ],
    safetyPhrases: [
      "初期不良は受領後7日以内に交換対応いたします。",
      "1年間のメーカー保証付きです（消耗品を除く）。",
      "お支払いは各種クレジット・コンビニ払いに対応しています。",
    ],
  },
  コスメ: {
    cooccurrence: [
      "SPF/PA",
      "トーンアップ",
      "白浮き",
      "石けんオフ",
      "敏感肌",
      "無香料",
      "紫外線吸収剤フリー",
      "アルコールフリー",
    ],
    numericTemplates: [
      "UVカット：SPF50+・PA++++",
      "使用量目安：パール粒2個分（約0.8g）",
      "内容量：30mL／開封後は6か月を目安",
    ],
    safetyPhrases: [
      "パッチテスト済みですが、すべての方に刺激がないわけではありません。",
      "石けんで落とせます（単体使用時）。",
      "香料・着色料フリー（詳細は成分表をご確認ください）。",
    ],
  },
  食品: {
    cooccurrence: [
      "個包装",
      "鮮度",
      "焙煎",
      "抽出量",
      "保存方法",
      "賞味期限",
      "原材料",
    ],
    numericTemplates: [
      "1杯あたり粉量：10–12g／お湯150–180mLが目安",
      "鮮度管理：焙煎後24時間以内に充填",
      "賞味期限：未開封で製造から約12か月（常温保存）",
    ],
    safetyPhrases: [
      "原材料にアレルギーがある方は成分表示をご確認ください。",
      "パッケージは予告なく変更される場合があります。",
      "定期便はいつでもスキップ可能です。",
    ],
  },
  アパレル: {
    cooccurrence: [
      "サイズ感",
      "生地厚",
      "伸縮性",
      "洗濯方法",
      "透け感",
      "シルエット",
      "着丈",
    ],
    numericTemplates: [
      "サイズ目安：着丈68cm／身幅52cm（M）※個体差±1–2cm",
      "生地：綿100%／生地厚：5.6oz",
      "洗濯：ネット使用・中性洗剤・陰干し推奨",
    ],
    safetyPhrases: [
      "自宅での試着後でも、未使用・タグ付きであれば30日以内の返品可。",
      "色味はモニター環境により実物と異なる場合があります。",
      "サイズ交換の送料は初回1回まで当店負担です。",
    ],
  },
  汎用: {
    cooccurrence: [
      "レビュー",
      "比較",
      "相性",
      "使い方",
      "保証",
      "サポート",
      "返品",
    ],
    numericTemplates: [
      "参考：30日返品保証／平日12時までの注文は当日出荷",
      "目安：本体約120g・長さ約150mm",
    ],
    safetyPhrases: [
      "受領後30日以内の未使用品は返品を承ります。",
      "土日祝の出荷は行っておりません（予約商品を除く）。",
      "ご不明点はチャットサポートで即時回答いたします。",
    ],
  },
};

/* =========================
   カテゴリ別 FAQ Seeds
========================= */

export type QA = { q: string; a: string; idx: number };

export function categoryFaqSeeds(cat: string): QA[] {
  const C = cat || "";
  const mk = (q: string, a: string): QA => ({
    q,
    a,
    idx: Number.MAX_SAFE_INTEGER,
  });

  if (/家電|electronic|電動|イヤホン|ヘッドホン|掃除機|冷蔵庫/i.test(C)) {
    return [
      mk(
        "保証期間はどのくらいですか？",
        "メーカー保証は1年間です（消耗品を除く）。延長保証も選べます。",
      ),
      mk(
        "対応機種や互換性は？",
        "Bluetooth 5.3に対応します。詳細な対応コーデックは商品仕様をご確認ください。",
      ),
    ];
  }

  if (/コスメ|化粧|美容|スキンケア|cosme|beauty/i.test(C)) {
    return [
      mk(
        "敏感肌でも使えますか？",
        "パッチテスト済ですが、すべての方に刺激がないとは限りません。心配な場合は腕の内側でお試しください。",
      ),
      mk(
        "石けんで落ちますか？",
        "単体使用時は洗顔料で落とせます。重ね使い時はクレンジングをおすすめします。",
      ),
    ];
  }

  if (/食品|フード|グルメ|food|gourmet|菓子|コーヒー|茶/i.test(C)) {
    return [
      mk(
        "賞味期限はどのくらいですか？",
        "未開封で製造から約12か月（常温）。開封後はお早めにお召し上がりください。",
      ),
      mk(
        "アレルギー表示は？",
        "主要7品目を含むアレルギー情報を商品ページに明記しています。",
      ),
    ];
  }

  if (/アパレル|衣料|ファッション|服|ウェア/i.test(C)) {
    return [
      mk(
        "サイズ交換は可能ですか？",
        "未使用・タグ付きで到着後30日以内は交換を承ります（初回送料は当店負担です）。",
      ),
      mk(
        "洗濯方法は？",
        "ネット使用・中性洗剤・陰干し推奨です。乾燥機は縮みの原因となるため避けてください。",
      ),
    ];
  }

  return faqSeeds.map((s) => ({
    q: s.q,
    a: s.a,
    idx: Number.MAX_SAFE_INTEGER,
  }));
}

/* =========================
   normalizeQ（FAQ 重複判定用）
========================= */

export function normalizeQ(s: string): string {
  let t = (s || "")
    .replace(/^[\s\d\.\):：）\-・\(\[]+/, "")
    .replace(/[？?\s\)\]]+$/g, "")
    .replace(/\s+/g, " ")
    .toLowerCase();

  const map: Array<[RegExp, string]> = [
    [/(返品|返金|交換)/g, "返品/交換"],
    [/(配送|到着|納期|発送|送料)/g, "配送/納期"],
    [/(支払い|支払|決済|支払方法)/g, "支払い方法"],
    [/(保証|修理|故障)/g, "保証"],
    [/(対応|互換|相性)/g, "対応/互換"],
    [/(アレルギー|含有|成分)/g, "アレルギー"],
    [/(サイズ|寸法|長さ)/g, "サイズ"],
  ];

  for (const [re, token] of map) {
    t = t.replace(re, token);
  }

  t = t.replace(/(は|って|とは|について|のこと|の)/g, "");
  t = t.replace(/\/{2,}/g, "/");

  return t.trim();
}
